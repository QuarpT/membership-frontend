package controllers

import actions.CommonActions._
import com.gu.subscriptions.CAS.{CASError, CASSuccess}
import com.typesafe.scalalogging.LazyLogging
import configuration.Config
import forms.CASForm
import play.api.libs.concurrent.Execution.Implicits._
import play.api.libs.json.Json
import play.api.mvc.Controller
import views.support.CASResultOps._

object CAS extends Controller with LazyLogging {
  def index = GoogleAuthenticatedStaffAction { implicit request =>
    Ok(views.html.staff.cas())
  }

  def searchSubscription = GoogleAuthenticatedStaffAction.async(parse.form(CASForm.lookup)) { request =>
    val lookup = request.body
    Config.casService.check(lookup.subscriptionNumber, lookup.postcode, lookup.lastName, triggersActivation = false).map {
      case r: CASSuccess => Ok(Json.toJson(r))
      case r: CASError => BadRequest(Json.toJson(r))
    }
  }

  def generateToken = GoogleAuthenticatedStaffAction(parse.form(CASForm.emergencyToken)) { request =>
    val tokenPayload = request.body
    val token = Config.CAS.emergencyEncoder.encode(tokenPayload)
    val obfuscatedToken =  "*" * (token.length - 4) + token.takeRight(4)
    logger.info(s"CAS emergency token generated by TODO: $obfuscatedToken")

    Ok(Json.obj("token" -> token))
  }
}
